<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>假装自己在唱歌（在线唱歌工具）</title>
    <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#ff4d4f',
                        secondary: '#f0f0f0',
                        dark: '#333333',
                        light: '#f9f9f9'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'glow': 'glow 2s ease-in-out infinite alternate',
                    },
                    keyframes: {
                        glow: {
                            '0%': { boxShadow: '0 0 5px rgba(255, 77, 79, 0.5)' },
                            '100%': { boxShadow: '0 0 20px rgba(255, 77, 79, 0.8), 0 0 30px rgba(255, 77, 79, 0.5)' },
                        }
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .lyric-line {
                @apply py-2 px-4 border-b border-gray-100 cursor-pointer transition-all duration-200;
            }
            .lyric-line:hover {
                @apply bg-gray-50;
            }
            .lyric-timestamp {
                @apply text-gray-400 text-sm mr-2;
            }
            .lyric-content {
                @apply text-dark;
            }
            .lyric-first-char {
                @apply text-primary font-bold;
            }
            .active-line {
                @apply bg-red-50 animate-glow rounded-md;
            }
            .active-line .lyric-content {
                @apply text-3xl font-bold;
            }
            .btn {
                @apply px-4 py-2 rounded-md transition-all duration-200 font-medium;
            }
            .btn-primary {
                @apply bg-primary text-white hover:bg-red-600;
            }
            .btn-secondary {
                @apply bg-gray-200 text-gray-700 hover:bg-gray-300;
            }
            .input-field {
                @apply w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50;
            }
            .card {
                @apply bg-white rounded-lg shadow-md p-6;
            }
            .mirror-video {
        	    @apply transform scale-x-[-1];
   	        }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- 顶部导航栏 -->
    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 max-w-5xl">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <a href="../index.html" class="text-blue-600 hover:text-blue-800 font-medium flex items-center">
                        <i class="fa fa-cloud mr-2"></i>
                        返回云上天国
                    </a>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="UserGuide.html" class="text-gray-700 hover:text-blue-600 font-medium">
                        查看操作指南
                    </a>
                    <a href="mailto:973256921@qq.com" class="text-gray-700 hover:text-blue-600 font-medium">
                        联系开发者
                    </a>
                </div>
            </div>
        </div>
    </nav>
    
    <div class="container mx-auto px-4 py-8 max-w-5xl">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">假装自己在唱歌</h1>
            <p class="text-gray-600">解析歌词，同步音频，练习演唱，录制视频</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- 左侧：歌词输入区 -->
            <div class="card">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fa fa-music mr-2 text-primary"></i>歌词输入
                </h2>
                <div class="mb-4">
                    <label for="lyricInput" class="block text-sm font-medium text-gray-700 mb-1">粘贴带时间戳的歌词：</label>
                    <textarea id="lyricInput" rows="8" class="input-field" placeholder="[00:00.000] 歌词内容&#10;[00:01.000] 下一句歌词"></textarea>
                </div>
                <div class="mb-4">
                    <label for="lyricFile" class="block text-sm font-medium text-gray-700 mb-1">或上传歌词文件（.txt格式）：</label>
                    <input type="file" id="lyricFile" accept=".txt" class="w-full p-2 border border-gray-300 rounded-md">
                </div>
                <button id="parseBtn" class="btn btn-primary w-full">
                    <i class="fa fa-magic mr-2"></i>解析歌词
                </button>
            </div>

            <!-- 右侧：音频上传区 -->
            <div class="card">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fa fa-upload mr-2 text-primary"></i>音频处理
                </h2>
                <div class="mb-4">
                    <label for="vocalFile" class="block text-sm font-medium text-gray-700 mb-1">上传纯人声MP3：</label>
                    <input type="file" id="vocalFile" accept="audio/mpeg" class="w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div class="mb-4">
                    <label for="accompanimentFile" class="block text-sm font-medium text-gray-700 mb-1">上传伴奏MP3（可选）：</label>
                    <input type="file" id="accompanimentFile" accept="audio/mpeg" class="w-full p-2 border border-gray-300 rounded-md">
                </div>
                <button id="processBtn" class="btn btn-primary w-full" disabled>
                    <i class="fa fa-cog mr-2"></i>处理音频
                </button>
            </div>
        </div>

        <!-- 录制区域：摄像头+歌词展示（核心录屏区域） -->
        <div id="recordArea" class="card mb-8">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <i class="fa fa-film mr-2 text-primary"></i>演唱预览与歌词同步
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <!-- 摄像头视频框 -->
                <div class="md:col-span-1">
                    <h3 class="text-lg font-medium mb-2 text-center text-gray-700">我的演唱画面</h3>
                    <div class="bg-gray-900 rounded-md overflow-hidden">
                        <video id="cameraVideo" width="100%" height="auto" autoplay muted class="w-full mirror-video"></video>
                    </div>
                    <p class="text-xs text-gray-500 mt-2 text-center">温馨提示：录制时请选择此区域所在的浏览器窗口</p>
                </div>

                <!-- 歌词展示框 -->
                <div class="md:col-span-3">
                    <h3 class="text-lg font-medium mb-2 text-center text-gray-700">歌词同步
                        <span id="lyricCount" class="ml-2 text-sm text-gray-500">(0句)</span>
                    </h3>
                    <div id="lyricContainer" class="max-h-96 overflow-y-auto bg-gray-50 rounded-md border border-gray-100">
                        <div class="p-4 text-center text-gray-500">
                            请先输入并解析歌词
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 录制控制区 -->
        <div class="card mb-8">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <i class="fa fa-video-camera mr-2 text-primary"></i>视频录制控制
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- 录制控制 -->
                <div>
                    <h3 class="text-lg font-medium mb-3">录屏控制</h3>
                    <div class="flex space-x-2 mb-4">
                        <button id="startRecordBtn" class="btn btn-primary flex-1">
                            <i class="fa fa-circle mr-2"></i>开始录制
                        </button>
                        <button id="stopRecordBtn" class="btn btn-secondary flex-1" disabled>
                            <i class="fa fa-stop mr-2"></i>停止录制
                        </button>
                    </div>
                    <a id="downloadRecordBtn" class="btn btn-secondary w-full inline-block text-center" disabled download>
                        <i class="fa fa-download mr-2"></i>下载录制视频
                    </a>
                </div>

                <!-- 音频与播放控制 -->
                <div>
                    <h3 class="text-lg font-medium mb-3">音频控制</h3>
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <button id="playAccompanimentBtn" class="btn btn-primary flex-1" disabled>
                            <i class="fa fa-play mr-2"></i>播放伴奏
                        </button>
                        <button id="stopAccompanimentBtn" class="btn btn-secondary flex-1" disabled>
                            <i class="fa fa-stop mr-2"></i>停止伴奏
                        </button>
                        <button id="recordBtn" class="btn btn-primary flex-1">
                            <i class="fa fa-microphone mr-2"></i>开始录音
                        </button>
                        <button id="stopRecordAudioBtn" class="btn btn-secondary flex-1" disabled>
                            <i class="fa fa-stop mr-2"></i>停止录音
                        </button>
                    </div>
                    <div class="mt-2">
                        <label for="volumeSlider" class="block text-sm font-medium text-gray-700 mb-1">伴奏音量：</label>
                        <input type="range" id="volumeSlider" min="0" max="1" step="0.1" value="0.7" class="w-full">
                    </div>
                </div>
            </div>
        </div>

        <!-- 音频播放器（隐藏） -->
        <audio id="vocalPlayer" preload="auto"></audio>
        <audio id="accompanimentPlayer" preload="auto"></audio>
        <audio id="recordPlayer" preload="auto"></audio>
    </div>

    <script>
        // 全局变量
        let lyrics = []; // 解析后的歌词数组
        let vocalAudio = null; // 人声音频URL
        let accompanimentAudio = null; // 伴奏音频URL
        let vocalBuffer = null; // 人声音频缓冲
        let recordedChunks = []; // 录音数据
        let mediaRecorder = null; // 录音器
        let isRecording = false; // 录音状态
        let currentActiveLyric = -1; // 当前激活的歌词索引
        
        // 视频录制相关变量
        let cameraStream = null; // 摄像头+麦克风流
        let screenStream = null; // 录屏流
        let mixedAudioStream = null; // 麦克风+伴奏混合音频流
        let videoRecorder = null; // 视频录制器
        let videoRecordedChunks = []; // 视频录制数据

        // DOM元素
        const lyricInput = document.getElementById('lyricInput');
        const lyricFile = document.getElementById('lyricFile');
        const parseBtn = document.getElementById('parseBtn');
        const vocalFile = document.getElementById('vocalFile');
        const accompanimentFile = document.getElementById('accompanimentFile');
        const processBtn = document.getElementById('processBtn');
        const lyricContainer = document.getElementById('lyricContainer');
        const lyricCount = document.getElementById('lyricCount');
        const recordBtn = document.getElementById('recordBtn');
        const stopRecordAudioBtn = document.getElementById('stopRecordAudioBtn');
        const playRecordBtn = document.getElementById('playRecordBtn');
        const clearRecordBtn = document.getElementById('clearRecordBtn');
        const playAccompanimentBtn = document.getElementById('playAccompanimentBtn');
        const stopAccompanimentBtn = document.getElementById('stopAccompanimentBtn');
        const volumeSlider = document.getElementById('volumeSlider');
        const vocalPlayer = document.getElementById('vocalPlayer');
        const accompanimentPlayer = document.getElementById('accompanimentPlayer');
        const recordPlayer = document.getElementById('recordPlayer');
        
        // 视频录制DOM元素
        const cameraVideo = document.getElementById('cameraVideo');
        const startRecordBtn = document.getElementById('startRecordBtn');
        const stopRecordBtn = document.getElementById('stopRecordBtn');
        const downloadRecordBtn = document.getElementById('downloadRecordBtn');

        // 示例歌词（Lush Life）
        const exampleLyrics = `[00:00.000] 作词 : NALYRO[00:01.000] 作曲 : NALYRO[00:15.680]I live my day as if it was the last[00:17.681]Live my day as if there was no past[00:19.681]Doin' it all night all summer[00:21.681]Doin' it the way I wanna[00:23.680]Yeah I'ma dance my heart out 'til the dawn[00:25.681]But I won't be done when morning comes[00:27.681]Doin' it all night all summer[00:29.931]Gonna spend it like no other[00:32.931]It was a crush[00:33.931]But I couldn't couldn't get enough[00:37.182]It was a rush[00:38.431]But I gave it up[00:41.357]It was a crush[00:42.357]Now I might've went and said too much[00:45.107]But that's all it was[00:46.358]So I gave it up[00:48.357]I live my day as if it was the last[00:50.107]Live my day as if there was no past[00:52.107]Doin' it all night all summer[00:54.107]Doin' it the way I wanna[00:56.107]Yeah I'ma dance my heart out 'til the dawn[00:58.357]But I won't be done when morning comes[01:00.357]Doin' it all night all summer[01:02.357]Gonna spend it like no other[01:05.471]It was a crush[01:06.721]I kept sayin' I'ma stay in touch[01:09.471]That thing went bust[01:10.721]So I gave it up ooh[01:13.472]No tricks no bluff[01:14.971]I'm just better off without them cuffs[01:16.971]Yeah the sun won't set on us[01:18.722]Ooh ooh ooh ooh yeah yeah[01:21.721]Went low went high[01:24.220]Still waters run dry[01:26.653]Gotta get back in the groove[01:28.403]I ain't ever worried[01:30.338]Went low went high what matters is now[01:32.282]Gettin' right back in the mood[01:38.227]Went low went high[01:40.478]What matters is now[01:42.977]Getting right back in the mood[01:45.227]I live my day as if it was the last[01:46.977]Live my day as if there was no past[01:49.226]Doin' it all night all summer[01:51.227]Doin' it the way I wanna[01:53.227]Yeah I'ma dance my heart out 'til the dawn[01:55.227]But I won't be done when morning comes[01:57.477]Doin' it all night all summer[01:59.227]Gonna spend it like no other[02:02.228]Now I've found another crush[02:04.226]The lush life's given me a rush[02:06.227]Had one chance to make me blush[02:08.227]Second time is one too late[02:10.226]Now I've found another crush[02:12.227]The lush life's given me a rush[02:14.227]Had one chance to make me blush[02:16.228]Second time is one too late[02:18.227]Now I've found another crush[02:20.477]The lush life's given me a rush[02:22.478]Had one chance to make me blush[02:24.477]Second time is one too late[02:26.477]Now I've found another crush[02:28.477]The lush life's given me a rush[02:30.477]Had one chance to make me blush[02:32.478]Second time is one too late`;

        // 初始化
        function init() {
            // 填充示例歌词
            lyricInput.value = exampleLyrics;
            
            // 初始化摄像头
            initCamera();
            
            // 绑定事件
            parseBtn.addEventListener('click', parseLyrics);
            lyricFile.addEventListener('change', handleLyricFileSelect);
            vocalFile.addEventListener('change', handleVocalFileSelect);
            accompanimentFile.addEventListener('change', handleAccompanimentFileSelect);
            processBtn.addEventListener('click', processAudio);
            recordBtn.addEventListener('click', startRecording);
            stopRecordAudioBtn.addEventListener('click', stopRecording);
            playAccompanimentBtn.addEventListener('click', playAccompaniment);
            stopAccompanimentBtn.addEventListener('click', stopAccompaniment);
            volumeSlider.addEventListener('input', adjustVolume);
            startRecordBtn.addEventListener('click', startVideoRecord);
            stopRecordBtn.addEventListener('click', stopVideoRecord);
            
            // 监听音频播放时间更新，用于歌词同步
            accompanimentPlayer.addEventListener('timeupdate', syncLyricsWithAudio);
            vocalPlayer.addEventListener('timeupdate', syncLyricsWithAudio);
            
            // 自动解析示例歌词
            parseLyrics();
        }

        // 初始化摄像头和麦克风
        function initCamera() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert('您的浏览器不支持摄像头功能，请使用Chrome/Edge/Firefox等现代浏览器');
                return;
            }
            
            navigator.mediaDevices.getUserMedia({
                video: { 
                    width: { ideal: 640 }, 
                    height: { ideal: 1000 },
                    facingMode: 'user' // 优先使用前置摄像头
                },
                audio: true
            }).then(stream => {
                cameraStream = stream;
                cameraVideo.srcObject = stream;
                cameraVideo.play();
            }).catch(err => {
                console.error('摄像头/麦克风初始化失败:', err);
                alert('请允许摄像头和麦克风权限，或检查设备是否可用\n' + err.message);
            });
        }

        // 混合音频（麦克风+伴奏）
        function mixAudio() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                // 麦克风音频源
                const micSource = audioContext.createMediaStreamSource(cameraStream);
                // 伴奏音频源
                const accompanimentSource = audioContext.createMediaStreamSource(accompanimentPlayer.captureStream());
                // 音频输出目标
                const destination = audioContext.createMediaStreamDestination();
                
                // 调整音量
                const micGain = audioContext.createGain();
                const accompanimentGain = audioContext.createGain();
                micGain.gain.value = 1;
                accompanimentGain.gain.value = volumeSlider.value;
                
                // 连接节点
                micSource.connect(micGain).connect(destination);
                accompanimentSource.connect(accompanimentGain).connect(destination);
                
                mixedAudioStream = destination.stream;
                return mixedAudioStream;
            } catch (err) {
                console.error('音频混合失败:', err);
                alert('音频混合失败，请确保伴奏已加载');
                return null;
            }
        }

        // 开始视频录制（录屏+音频）
        function startVideoRecord() {
            if (!cameraStream) {
                alert('摄像头未初始化，请检查设备权限！');
                return;
            }
            
            // 混合音频
            const mixedAudio = mixAudio();
            if (!mixedAudio) return;
            
            // 调用录屏API
            navigator.mediaDevices.getDisplayMedia({
                video: {
                    cursor: 'visible',
                    displaySurface: 'browser'
                },
                audio: false // 禁用录屏音频，使用自己混合的音频
            }).then(stream => {
                screenStream = stream;
                
                // 合并录屏视频流和混合音频流
                const finalStream = new MediaStream();
                // 添加视频轨道
                screenStream.getVideoTracks().forEach(track => finalStream.addTrack(track));
                // 添加音频轨道
                mixedAudio.getAudioTracks().forEach(track => finalStream.addTrack(track));
                
                // 初始化视频录制器
                const options = { mimeType: 'video/webm; codecs=vp9' };
                // 兼容不同浏览器的格式
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    options.mimeType = 'video/webm; codecs=vp8';
                }
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    options.mimeType = 'video/webm';
                }
                
                videoRecorder = new MediaRecorder(finalStream, options);
                videoRecordedChunks = [];
                
                // 收集录制数据
                videoRecorder.ondataavailable = e => {
                    if (e.data.size > 0) {
                        videoRecordedChunks.push(e.data);
                    }
                };
                
                // 录制停止回调
                videoRecorder.onstop = () => {
                    // 生成视频文件
                    const videoBlob = new Blob(videoRecordedChunks, { type: 'video/webm' });
                    const videoUrl = URL.createObjectURL(videoBlob);
                    
                    // 设置下载链接
                    downloadRecordBtn.href = videoUrl;
                    downloadRecordBtn.download = `演唱录制_${new Date().getTime()}.webm`;
                    downloadRecordBtn.disabled = false;
                    
                    // 释放流
                    screenStream.getTracks().forEach(track => track.stop());
                    
                    // 恢复UI状态
                    startRecordBtn.disabled = false;
                    stopRecordBtn.disabled = true;
                    startRecordBtn.innerHTML = '<i class="fa fa-circle mr-2"></i>开始录制';
                };
                
                // 开始录制
                videoRecorder.start(100); // 每100ms切片，提高兼容性
                
                // 更新UI
                startRecordBtn.disabled = true;
                stopRecordBtn.disabled = false;
                startRecordBtn.innerHTML = '<i class="fa fa-circle text-red-500 animate-pulse mr-2"></i>录制中...';
                
                // 监听录屏流结束
                screenStream.addEventListener('inactive', () => {
                    if (videoRecorder && videoRecorder.state === 'recording') {
                        videoRecorder.stop();
                    }
                });
                
            }).catch(err => {
                console.error('录屏权限获取失败:', err);
                alert('请允许录屏权限，否则无法录制视频！\n' + err.message);
                startRecordBtn.disabled = false;
            });
        }

        // 停止视频录制
        function stopVideoRecord() {
            if (videoRecorder && videoRecorder.state === 'recording') {
                videoRecorder.stop();
            }
            
            // 停止录屏流
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
            }
            
            // 更新UI
            startRecordBtn.disabled = false;
            stopRecordBtn.disabled = true;
            startRecordBtn.innerHTML = '<i class="fa fa-circle mr-2"></i>开始录制';
        }

        // 解析歌词
        function parseLyrics() {
            const input = lyricInput.value.trim();
            if (!input) {
                alert('请输入歌词！');
                return;
            }

            lyrics = [];
            const regex = /\[(\d{2}):(\d{2})\.(\d{2,3})\]([^[\]]*)/g;
            let match;
            
            while ((match = regex.exec(input)) !== null) {
                const minutes = parseInt(match[1], 10);
                const seconds = parseInt(match[2], 10);
                const milliseconds = parseInt(match[3], 10);
                const time = minutes * 60 + seconds + (match[3].length === 3 ? milliseconds / 1000 : milliseconds / 100);
                const text = match[4].trim();
                
                if (text) {
                    const msStr = match[3].length === 3 ? match[3] : match[3] + '0';
                    const timeStr = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${msStr}`;
                    
                    lyrics.push({
                        time,
                        text,
                        timeStr
                    });
                }
            }
            
            lyrics.sort((a, b) => a.time - b.time);
            updateLyricDisplay();
            updateLyricCount();
            
            if (vocalFile.files.length > 0) {
                processBtn.disabled = false;
            }
        }

        // 更新歌词显示
        function updateLyricDisplay() {
            if (lyrics.length === 0) {
                lyricContainer.innerHTML = '<div class="p-4 text-center text-gray-500">没有找到有效的歌词</div>';
                return;
            }
            
            lyricContainer.innerHTML = '';
            
            lyrics.forEach((lyric, index) => {
                const lyricLine = document.createElement('div');
                lyricLine.className = 'lyric-line';
                lyricLine.dataset.index = index;
                lyricLine.dataset.time = lyric.time;
                
                const firstChar = lyric.text[0] || '';
                const contentRest = lyric.text.slice(1) || '';
                let contentHtml = `<span class="lyric-first-char">${firstChar}</span>${contentRest}`;
                
                lyricLine.innerHTML = `
                    <span class="lyric-timestamp">[${lyric.timeStr}]</span>
                    <span class="lyric-content">${contentHtml}</span>
                `;
                
                lyricLine.addEventListener('click', () => playLyricWithAudio(index));
                lyricContainer.appendChild(lyricLine);
            });
        }

        // 更新歌词计数
        function updateLyricCount() {
            lyricCount.textContent = `(${lyrics.length}句)`;
        }

        // 处理人声文件选择
        function handleVocalFileSelect(event) {
            const file = event.target.files[0];
            if (file && file.type === 'audio/mpeg') {
                vocalAudio = URL.createObjectURL(file);
                vocalPlayer.src = vocalAudio;
                
                if (lyrics.length > 0) {
                    processBtn.disabled = false;
                }
            } else {
                alert('请上传MP3格式的音频文件！');
                vocalFile.value = '';
            }
        }

        // 处理伴奏文件选择
        function handleAccompanimentFileSelect(event) {
            const file = event.target.files[0];
            if (file && file.type === 'audio/mpeg') {
                accompanimentAudio = URL.createObjectURL(file);
                accompanimentPlayer.src = accompanimentAudio;
                playAccompanimentBtn.disabled = false;
                stopAccompanimentBtn.disabled = false;
            } else if (file) {
                alert('请上传MP3格式的音频文件！');
                accompanimentFile.value = '';
            }
        }
        
        // 处理歌词文件选择
        function handleLyricFileSelect(event) {
            const file = event.target.files[0];
            if (file && (file.name.endsWith('.txt') || file.type === 'text/plain')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    lyricInput.value = e.target.result;
                    // 文件加载完成后自动解析歌词
                    parseLyrics();
                };
                reader.readAsText(file, 'utf-8');
            } else if (file) {
                alert('请上传TXT格式的歌词文件！');
                lyricFile.value = '';
            }
        }

        // 处理音频
        function processAudio() {
            if (!vocalAudio || lyrics.length === 0) {
                alert('请先上传人声音频并解析歌词！');
                return;
            }
            
            processBtn.disabled = true;
            processBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>处理中...';
            
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            fetch(vocalAudio)
                .then(response => response.arrayBuffer())
                .then(arrayBuffer => audioContext.decodeAudioData(arrayBuffer))
                .then(buffer => {
                    vocalBuffer = buffer;
                    processBtn.innerHTML = '<i class="fa fa-check mr-2"></i>处理完成';
                    processBtn.classList.remove('btn-primary');
                    processBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                    alert('音频处理完成！播放音频时歌词会自动同步高亮，点击歌词也可跳转到对应时间。');
                })
                .catch(error => {
                    console.error('音频处理失败:', error);
                    alert('音频处理失败，请重试！');
                    processBtn.disabled = false;
                    processBtn.innerHTML = '<i class="fa fa-cog mr-2"></i>处理音频';
                });
        }

        // 播放歌词对应的音频
        function playLyricWithAudio(index) {
            const lyricTime = lyrics[index].time;
            
            if (accompanimentAudio) {
                accompanimentPlayer.currentTime = lyricTime;
                accompanimentPlayer.play().catch(err => console.log('伴奏播放失败:', err));
            }
            
            if (vocalBuffer) {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createBufferSource();
                source.buffer = vocalBuffer;
                source.connect(audioContext.destination);
                source.start(0, lyricTime, 1);
            } else if (vocalAudio) {
                vocalPlayer.currentTime = lyricTime;
                vocalPlayer.play();
                setTimeout(() => {
                    vocalPlayer.pause();
                }, 1000);
            } else {
                alert('请先上传并处理人声音频！');
            }
        }

        // 同步歌词与音频播放时间
        function syncLyricsWithAudio() {
            let currentTime = 0;
            if (!isNaN(accompanimentPlayer.currentTime) && accompanimentPlayer.currentTime > 0) {
                currentTime = accompanimentPlayer.currentTime;
            } else if (!isNaN(vocalPlayer.currentTime) && vocalPlayer.currentTime > 0) {
                currentTime = vocalPlayer.currentTime;
            }
            
            let matchedIndex = -1;
            for (let i = lyrics.length - 1; i >= 0; i--) {
                if (lyrics[i].time <= currentTime) {
                    matchedIndex = i;
                    break;
                }
            }
            
            if (matchedIndex !== currentActiveLyric) {
                if (currentActiveLyric >= 0) {
                    const prevLine = document.querySelector(`[data-index="${currentActiveLyric}"]`);
                    if (prevLine) prevLine.classList.remove('active-line');
                }
                
                currentActiveLyric = matchedIndex;
                if (currentActiveLyric >= 0) {
                    const currentLine = document.querySelector(`[data-index="${currentActiveLyric}"]`);
                    if (currentLine) {
                        currentLine.classList.add('active-line');
                        currentLine.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            }
        }

        // 开始录音
        function startRecording() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    recordedChunks = [];
                    
                    mediaRecorder.ondataavailable = event => {
                        if (event.data.size > 0) recordedChunks.push(event.data);
                    };
                    
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(recordedChunks, { type: 'audio/webm' });
                        recordPlayer.src = URL.createObjectURL(audioBlob);
                    };
                    
                    mediaRecorder.start();
                    isRecording = true;
                    
                    recordBtn.disabled = true;
                    stopRecordAudioBtn.disabled = false;
                    recordBtn.innerHTML = '<i class="fa fa-circle text-red-500 animate-pulse mr-2"></i>录音中...';
                })
                .catch(error => {
                    console.error('无法访问麦克风:', error);
                    alert('无法访问麦克风，请检查权限设置！');
                });
        }

        // 停止录音
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                
                recordBtn.disabled = false;
                stopRecordAudioBtn.disabled = true;
                recordBtn.innerHTML = '<i class="fa fa-circle mr-2"></i>开始录音';
            }
        }

        // 播放伴奏
        function playAccompaniment() {
            if (accompanimentAudio) {
                accompanimentPlayer.play();
            } else {
                alert('请先上传伴奏文件！');
            }
        }

        // 停止伴奏
        function stopAccompaniment() {
            accompanimentPlayer.pause();
            accompanimentPlayer.currentTime = 0;
            
            if (currentActiveLyric >= 0) {
                const prevLine = document.querySelector(`[data-index="${currentActiveLyric}"]`);
                if (prevLine) prevLine.classList.remove('active-line');
                currentActiveLyric = -1;
            }
        }

        // 调整音量
        function adjustVolume() {
            accompanimentPlayer.volume = volumeSlider.value;
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
